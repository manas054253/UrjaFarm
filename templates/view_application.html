{% extends "base.html" %}

{% block title %}Application Details - SmartCredit{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<style>
    :root {
        --primary: #667eea;
        --primary-dark: #764ba2;
        --success: #00d4aa;
        --warning: #ffd93d;
        --danger: #ff6b6b;
        --text-dark: #1a202c;
        --text-light: #718096;
        --bg-light: #f7fafc;
        --white: #ffffff;
        --shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
        --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.06);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background: linear-gradient(135deg, var(--bg-light) 0%, #e9ecef 100%);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        color: var(--text-dark);
    }

    .content-wrapper {
        max-width: 1300px;
        margin: 0 auto;
        padding: 2rem;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
        color: var(--primary);
        text-decoration: none;
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 2rem;
        transition: all 0.3s;
    }

    .back-link:hover {
        color: var(--primary-dark);
        gap: 1rem;
    }

    .main-panel {
        background: var(--white);
        border-radius: 20px;
        box-shadow: var(--shadow);
        padding: 2.5rem;
        overflow: hidden;
    }

    .hero-section {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 3rem;
        align-items: center;
        margin-bottom: 2.5rem;
        padding-bottom: 2.5rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .hero-left h1 {
        font-size: 2rem;
        font-weight: 800;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
    }

    .hero-left p {
        color: var(--text-light);
        font-size: 0.95rem;
        margin: 0.3rem 0;
    }

    .hero-left .meta {
        display: flex;
        gap: 2rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
    }

    .meta-item {
        display: flex;
        flex-direction: column;
    }

    .meta-label {
        font-size: 0.8rem;
        color: var(--text-light);
        text-transform: uppercase;
        font-weight: 700;
        letter-spacing: 0.5px;
        margin-bottom: 0.4rem;
    }

    .meta-value {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--text-dark);
    }

    .score-card {
        position: relative;
        width: 180px;
        height: 180px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        border-radius: 20px;
        box-shadow: 0 15px 40px rgba(102, 126, 234, 0.25);
    }

    .score-content {
        text-align: center;
        z-index: 2;
    }

    .score-number {
        font-size: 3.5rem;
        font-weight: 900;
        color: var(--white);
        line-height: 1;
    }

    .score-label {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.9);
        margin-top: 0.5rem;
    }

    .risk-badge {
        position: absolute;
        top: -10px;
        right: -10px;
        padding: 0.7rem 1.2rem;
        border-radius: 50px;
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .risk-low {
        background: var(--success);
        color: #fff;
    }

    .risk-medium {
        background: var(--warning);
        color: #333;
    }

    .risk-high {
        background: var(--danger);
        color: #fff;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1.2rem;
        margin-bottom: 2.5rem;
    }

    .stat-box {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(0, 212, 170, 0.05) 100%);
        border: 1px solid rgba(102, 126, 234, 0.1);
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s;
        cursor: default;
    }

    .stat-box:hover {
        border-color: var(--primary);
        box-shadow: var(--shadow-sm);
        transform: translateY(-2px);
    }

    .stat-icon {
        font-size: 1.8rem;
        margin-bottom: 0.8rem;
    }

    .stat-label {
        font-size: 0.8rem;
        color: var(--text-light);
        text-transform: uppercase;
        font-weight: 700;
        letter-spacing: 0.4px;
        margin-bottom: 0.6rem;
    }

    .stat-value {
        font-size: 1.8rem;
        font-weight: 800;
        color: var(--text-dark);
    }

    .charts-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.8rem;
    }

    .chart-card {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.03) 0%, rgba(255, 255, 255) 100%);
        border: 1px solid #e2e8f0;
        border-radius: 15px;
        padding: 1.8rem;
        transition: all 0.3s;
    }

    .chart-card:hover {
        border-color: var(--primary);
        box-shadow: var(--shadow-sm);
        transform: translateY(-3px);
    }

    .chart-header {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        margin-bottom: 1.5rem;
    }

    .chart-icon {
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        border-radius: 12px;
    }

    .chart-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-dark);
    }

    .chart-canvas {
        position: relative;
        height: 240px;
        margin-bottom: 1rem;
    }

    .chart-note {
        font-size: 0.85rem;
        color: var(--text-light);
        text-align: center;
        line-height: 1.6;
    }

    .decision-section {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        margin-top: 2.5rem;
        box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);
    }

    .decision-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.2rem;
    }

    .decision-icon {
        font-size: 2rem;
    }

    .decision-title {
        font-size: 1.4rem;
        font-weight: 800;
    }

    .decision-text {
        font-size: 1rem;
        line-height: 1.8;
        opacity: 0.95;
        margin-bottom: 1.5rem;
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .btn {
        padding: 0.9rem 2rem;
        border: none;
        border-radius: 12px;
        font-size: 0.95rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 0.6rem;
    }

    .btn-approve {
        background: var(--success);
        color: white;
        box-shadow: 0 10px 25px rgba(0, 212, 170, 0.3);
    }

    .btn-approve:hover {
        background: #00b894;
        transform: translateY(-2px);
        box-shadow: 0 15px 35px rgba(0, 212, 170, 0.4);
    }

    .btn-info {
        background: white;
        color: var(--primary);
        box-shadow: 0 10px 25px rgba(255, 255, 255, 0.3);
    }

    .btn-info:hover {
        background: #f0f0f0;
        transform: translateY(-2px);
    }

    .btn-reject {
        background: var(--danger);
        color: white;
        box-shadow: 0 10px 25px rgba(255, 107, 107, 0.3);
    }

    .btn-reject:hover {
        background: #ff5252;
        transform: translateY(-2px);
        box-shadow: 0 15px 35px rgba(255, 107, 107, 0.4);
    }

    @media (max-width: 768px) {
        .hero-section {
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .score-card {
            width: 150px;
            height: 150px;
        }

        .score-number {
            font-size: 2.8rem;
        }

        .main-panel {
            padding: 1.5rem;
        }

        .charts-container {
            grid-template-columns: 1fr;
        }

        .action-buttons {
            flex-direction: column;
        }

        .btn {
            width: 100%;
            justify-content: center;
        }
    }
</style>

<a href="{{ url_for('admin_dashboard') }}" class="back-link">
    <i class="fas fa-arrow-left"></i> Back to Dashboard
</a>

<div class="main-panel">
    <div class="hero-section">
        <div class="hero-left">
            <h1>{{ app.applicant.name }}</h1>
            <p>{{ app.applicant.email }}</p>
            <p style="font-size: 0.85rem; color: #a0aec0;">Submitted on {% if app.timestamp %}{{ app.timestamp.strftime('%B %d, %Y') }}{% else %}N/A{% endif %}</p>
            
            <div class="meta">
                <div class="meta-item">
                    <span class="meta-label">Daily Sales</span>
                    <span class="meta-value">‚Çπ{{ "{:,.0f}".format(app.avg_daily_sales|default(0)/1000) }}K</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Recharge</span>
                    <span class="meta-value">‚Çπ{{ "{:,.0f}".format(app.avg_monthly_recharge|default(0)) }}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Mobile Age</span>
                    <span class="meta-value">{{ app.mobile_age_years }}y</span>
                </div>
            </div>
        </div>

        <div class="score-card">
            <div class="score-content">
                <div class="score-number">{{ app.credit_score }}</div>
                <div class="score-label">/ 1000</div>
            </div>
            <div class="risk-badge {% if app.risk_status == 'Low Risk' %}risk-low{% elif app.risk_status == 'Medium Risk' %}risk-medium{% else %}risk-high{% endif %}">
                {% if app.risk_status == 'Low Risk' %}‚úÖ Low{% elif app.risk_status == 'Medium Risk' %}‚ö†Ô∏è Medium{% else %}üö® High{% endif %}
            </div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-box">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-label">Bills On Time</div>
            <div class="stat-value">{{ app.bills_paid_on_time_12m }}/12</div>
        </div>

        <div class="stat-box">
            <div class="stat-icon">üìä</div>
            <div class="stat-label">Days No Sales</div>
            <div class="stat-value">{{ app.days_with_no_sales }}</div>
        </div>

        <div class="stat-box">
            <div class="stat-icon">{% if app.is_bill_overdue_30d == 0 %}‚úÖ{% else %}‚ö†Ô∏è{% endif %}</div>
            <div class="stat-label">Overdue 30+</div>
            <div class="stat-value">{% if app.is_bill_overdue_30d == 0 %}No{% else %}Yes{% endif %}</div>
        </div>

        <div class="stat-box">
            <div class="stat-icon">üì±</div>
            <div class="stat-label">Avg Bill</div>
            <div class="stat-value">‚Çπ{{ "{:,.0f}".format(app.avg_bill_amount|default(0)) }}</div>
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-icon"><i class="fas fa-chart-pie"></i></div>
                <div class="chart-title">Payment Consistency</div>
            </div>
            <div class="chart-canvas">
                <canvas id="paymentChart"></canvas>
            </div>
            <div class="chart-note">
                {% if app.is_bill_overdue_30d == 0 %}
                    ‚úÖ No overdue bills detected
                {% else %}
                    ‚ö†Ô∏è Bills overdue 30+ days
                {% endif %}
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-icon"><i class="fas fa-chart-bar"></i></div>
                <div class="chart-title">Performance Metrics</div>
            </div>
            <div class="chart-canvas">
                <canvas id="performanceChart"></canvas>
            </div>
            <div class="chart-note">Business and digital activity overview</div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-icon"><i class="fas fa-heart"></i></div>
                <div class="chart-title">Financial Health</div>
            </div>
            <div class="chart-canvas">
                <canvas id="healthChart"></canvas>
            </div>
            <div class="chart-note">Multi-dimensional assessment</div>
        </div>
    </div>

    <div class="decision-section">
        <div class="decision-header">
            <div class="decision-icon">ü§ñ</div>
            <div class="decision-title">AI Recommendation</div>
        </div>
        
        <div class="decision-text">
            {% if app.risk_status == 'Low Risk' %}
                <strong>‚úÖ APPROVE WITH CONFIDENCE</strong> ‚Äî Excellent credit profile with strong payment history and stable business performance. Recommend approval with favorable rates (14-16%).
            {% elif app.risk_status == 'Medium Risk' %}
                <strong>‚ö†Ô∏è CONDITIONAL APPROVAL</strong> ‚Äî Mixed indicators detected. Profile shows potential but requires additional verification or higher rates (18-20%). Request more documentation.
            {% else %}
                <strong>üö® REVIEW REQUIRED</strong> ‚Äî High-risk profile detected. Significant concerns identified. Recommend deeper review or requesting additional documentation before approval.
            {% endif %}
        </div>

        <div class="action-buttons">
            <button class="btn btn-approve" onclick="alert('‚úÖ Application approved!')">
                <i class="fas fa-check-circle"></i> Approve
            </button>
            <button class="btn btn-info" onclick="alert('‚ÑπÔ∏è More info request sent!')">
                <i class="fas fa-info-circle"></i> More Info
            </button>
            <button class="btn btn-reject" onclick="alert('‚ùå Application rejected!')">
                <i class="fas fa-times-circle"></i> Reject
            </button>
        </div>
    </div>
</div>

<script>
    const colors = {
        primary: '#667eea',
        success: '#00d4aa',
        warning: '#ffd93d',
        danger: '#ff6b6b',
        light: '#e2e8f0'
    };

    const paymentCtx = document.getElementById('paymentChart').getContext('2d');
    new Chart(paymentCtx, {
        type: 'doughnut',
        data: {
            labels: ['On Time', 'Missed'],
            datasets: [{
                data: [{{ app.bills_paid_on_time_12m }}, {{ 12 - app.bills_paid_on_time_12m }}],
                backgroundColor: [colors.success, colors.light],
                borderColor: ['transparent', 'transparent'],
                borderRadius: 8,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: { size: 12, weight: 'bold' },
                        padding: 20,
                        usePointStyle: true
                    }
                }
            }
        }
    });

    const perfCtx = document.getElementById('performanceChart').getContext('2d');
    new Chart(perfCtx, {
        type: 'bar',
        data: {
            labels: ['Daily Sales', 'Monthly Recharge', 'Mobile Age'],
            datasets: [{
                label: 'Value',
                data: [
                    Math.min({{ app.avg_daily_sales|default(0) / 500 }}, 100),
                    Math.min({{ app.avg_monthly_recharge|default(0) / 50 }}, 100),
                    {{ app.mobile_age_years * 10 }}
                ],
                backgroundColor: [colors.primary, colors.success, colors.warning],
                borderRadius: 8,
                borderSkipped: false
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { beginAtZero: true, max: 100, ticks: { display: false }, grid: { display: false } }
            }
        }
    });

    const healthCtx = document.getElementById('healthChart').getContext('2d');
    new Chart(healthCtx, {
        type: 'radar',
        data: {
            labels: ['Payment', 'Sales', 'Stability', 'Digital', 'Activity'],
            datasets: [{
                label: 'Score',
                data: [
                    {{ (app.bills_paid_on_time_12m / 12) * 100 }},
                    Math.min({{ (app.avg_daily_sales|default(0) / 500) }}, 100),
                    Math.min(100 - ({{ app.days_with_no_sales }} * 5), 100),
                    Math.min({{ app.mobile_age_years * 15 }}, 100),
                    Math.min({{ app.avg_monthly_recharge|default(0) / 10 }}, 100)
                ],
                borderColor: colors.primary,
                backgroundColor: 'rgba(102, 126, 234, 0.15)',
                pointBackgroundColor: colors.primary,
                pointBorderColor: 'white',
                pointBorderWidth: 2,
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: { stepSize: 25, font: { size: 11 } },
                    grid: { color: 'rgba(0,0,0,0.05)' }
                }
            },
            plugins: { legend: { display: false } }
        }
    });
</script>
{% endblock %}